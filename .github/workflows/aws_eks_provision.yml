name: EKS - Provision STAGING ðŸ—ï¸

on: [push]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: 'eu-north-1'
  ROUTE53_DOMAIN_NAME: callistademo.org
  WORK_DIR: aws/eks-gitops

jobs:
  provision-eks-with-pulumi:
    runs-on: ubuntu-latest
    # env:
    #   PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
    # Create an GitHub environment referencing our EKS cluster endpoint
    environment:
      name: 'aws-eks-staging'
    #   url: ${{ steps.traefik-expose.outputs.traefik_url }}
      # using outputs for providing the Pulumi created kubeconfig to subsequent jobs
      # see https://stackoverflow.com/a/61236803/4964553
      # & see https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idoutputs
    outputs:
      kubeconfig: ${{ steps.pulumi-up.outputs.kubeconfig }}
      kubeconfig2: ${{ steps.kube-conf.outputs.kubeconfig2 }}
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3
      
      - name: Setup Node âœ¨
        uses: actions/setup-node@v3
        with:
          node-version: 16
      
      - name: Configure AWS Credentials ðŸ”
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ secrets.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows
      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Pulumi dependencies ðŸ“¦ï¸ 
        run: npm install
        working-directory: ${{ env.WORK_DIR }}
      
      # - name: Install Pulumi CLI
      #   uses: pulumi/action-install-pulumi-cli@v2
      
      - name: Provision Infrastructure ðŸ—ï¸
        uses: pulumi/actions@v3
        id: pulumi-up
        with:
          command: up
          stack-name: staging # When using an individual account, only use stack-name.
          work-dir: ${{ env.WORK_DIR }}
          refresh: true;
          comment-on-pr: true;
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      # - name: Provision AWS EKS cluster with Pulumi
      #   id: pulumi-up
      #   run: |
      #     pulumi stack select staging
      #     pulumi preview
      #     echo "lets use --suppress-outputs here in order to prevent Pulumi from logging the kubeconfig into public GitHub Action logs"
      #     pulumi up --yes --suppress-outputs
      #     echo "Create ~/.kube dir only, if not already existent (see https://stackoverflow.com/a/793867/4964553)"
      #     mkdir -p ~/.kube
      #     echo "Create kubeconfig and supply it for depending Action jobs"
      #     pulumi stack output kubeconfig > ~/.kube/config
      #     echo "::set-output name=kubeconfig::$(pulumi stack output kubeconfig)"
      #   working-directory: ${{ env.WORK_DIR }}

        # https://stackoverflow.com/questions/59175332/using-output-from-a-previous-job-in-a-new-one-in-a-github-action
      - name: Try to connect to EKS cluster ðŸ”Œ
        id: kube-conf
        run: |
          mkdir -p ~/.kube
          echo '${{ steps.pulumi-up.outputs.kubeconfig }}' > ~/.kube/config
          echo "--- Checking connectivity to cluster"
          kubectl get nodes
          kubectl version --short          

  install-and-run-argocd-on-eks:
    runs-on: ubuntu-latest
    needs: provision-eks-with-pulumi
    environment:
      name: argocd-dashboard-staging
      url: ${{ steps.dashboard-expose.outputs.dashboard_host }}
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3
      
      - name: Setup Node âœ¨
        uses: actions/setup-node@v3
        with:
          node-version: 16
      
      - name: Configure AWS Credentials ðŸ”
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ secrets.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows
      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Pulumi dependencies ðŸ“¦ï¸ 
        run: npm install
        working-directory: ${{ env.WORK_DIR }}

      - name: Install Pulumi ðŸ—ï¸
        uses: pulumi/actions@v3
        with:
          command: preview # This step is only here to install Pulumi CLI to execute in next step...
          stack-name: staging # When using an individual account, only use stack-name.
          work-dir: ${{ env.WORK_DIR }}
          refresh: true;
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Install Argo CD 
        id: pulumi-up-argocd # same as step in previous job, but with Argo CD setup added
        # with:
        #   command: up
        #   stack-name: staging # When using an individual account, only use stack-name.
        #   work-dir: ${{ env.WORK_DIR }}
        #   refresh: true;
        run: |
          pulumi stack select staging
          mkdir -p ~/.kube
          pulumi stack output kubeconfig --show-secrets  > ~/.kube/config
          export SETUP_ARGO_CD=yep
          echo "lets use --suppress-outputs here in order to prevent Pulumi from logging the kubeconfig into public GitHub Action logs"
          pulumi up -y --suppress-outputs
          echo "::set-output name=kubeconfig::$(pulumi stack output kubeconfig --show-secrets)"
        working-directory: ${{ env.WORK_DIR }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          SETUP_ARGO_CD: true

      - name: Verify ArgoCD
        run: |
          mkdir -p ~/.kube
          echo '${{ steps.pulumi-up-argod.outputs.kubeconfig }}' > ~/.kube/config
          echo "--- Checking connectivity to cluster"
          kubectl get nodes
          kubectl version --short     
          echo "--- Wait until Secret argocd-initial-admin-secret got created for the following argocd login"
          until kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data}" | grep "password"; do : ; done
          echo "--- Wait until (hopefully) ArgoCD server deployment is ready to be logged in to"
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd
          # echo "--- Login argocd CLI - now wrapped in until to prevent dial tcp: lookup <...>: no such host (see https://stackoverflow.com/a/71030112/4964553)"
          # until argocd login ${{ steps.pulumi-up-argocd.outputs.argoCDUrl }} --username admin --password $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo) --insecure; do : ; done
          # echo "--- Deploy APP definition ?? TODO"
          # kubectl apply -f argocd/argocd-appproject-apps2deploy.yml
         